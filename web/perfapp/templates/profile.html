{% extends "base.html" %}
{% load static %}
{% load tz %}
{% block head %}
<title> Profile</title>
<script>
  function redirect(){
    window.location.href = "/profile/";
  } setTimeout(redirect, 300000);
</script>
{% endblock %}

{% block content %}
&nbsp;
<div class="grid-container fluid">
  <div class="grid-x grid-padding-x align-center">
    <div class="cell medium-8">
    <h4>User #: {{user.id}}</h4>
    {% if history != None%}
    <form action="{% url 'perfapp:Clear_All_Att'%}" method="post">
    {% csrf_token %}
    <input type="Submit" class="hollow button alert" value="Clear All Attempts" onclick="return confirm('Are you sure? This cannot be undone.')" />
    </form>
    {% endif%}
  </div>
  </div>
  <div class="grid-x grid-padding-x align-center">
    <div class="cell medium-8">
      <table>
        <thead>
          <tr data-toggle="_attempts_table">
            <th style="display:none"></th>
            <th>Attempt #</th>
            <th>Score</th>
            <th>&nbsp;</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in history %}
          <tr data-toggle="att_drop_{{entry.id}}">
            <td>{{entry.id}}</td>
            <td>{{entry.score}}</td>
            <td>&nbsp</td>
            <td>{{entry.time_stamp}}</td>
            <div class="dropdown-pane" id="att_drop_{{entry.id}}" data-dropdown data-hover="true" data-hover-pane="true">
              {{entry.result_out|linebreaksbr}}
              {% if entry.notefield != None%}
              </br>
              {{entry.notefield|linebreaksbr}}
              {%endif%}
              </br></br>
              <form action="{% url 'perfapp:Delete_Att' entry.id %}" method="post">
                {% csrf_token %}
                <input type="Submit" class="hollow button alert" value="Clear Attempt" />
              </form>
            </div>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="grid-x grid-padding-x align-center">
    <div class="cell">&nbsp</div>
      <div class="cell medium-8">
        <a href="/submit/" class="button">New Submission</a>
        <a href="/clear/" class="button alert" onclick="return confirm('Are you sure? This cannot be undone.')">Clear Job Queue</a>
      </div>
  </div>
  <div class="grid-x grid-padding-x align-center">
    <div class="cell medium-8">
      <table class="hover">
        <thead>
          <tr>
            <th>Job #</th>
            <th>Status</th>
            <th>Time started</th>
            <th>&nbsp;</th>
            <th>&nbsp;</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in open_jobs %}
          <tr id="row_{{entry.object.id}}" data-open="Modal-{{entry.object.id}}">
            <div class="reveal" id="Modal-{{entry.object.id}}" data-reveal>
            <h4 id="_action_{{entry.object.id}}">{{entry.object.cur_action}}</h4>
            <button class="close-button" data-close aria-label="close modal" type="button">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
            <td>{{entry.object.jid}}</td>
            <td><p id="_status_{{entry.object.id}}">{{entry.object.status}}</p></td>
            {% localtime on  %}
            <td>{{entry.object.time_created}}</td>
            {% endlocaltime %}
            {% if entry.object.status == 'RUNNING'%}
            <td>
              <div id="_prog_wrapper" class="progress-wrapper" style="display:none">
                <div id="progress-bar {{entry.object.jid}}" class="progress-bar" style="background-color: #68a9ef; width: 100%;">&nbsp</div>
              </div>
              <div id="progress-bar-message {{entry.object.jid}}">Waiting...</div>
            </td>

            <td>
              <div id="_action_button">
              <form action="{% url 'perfapp:Stop' entry.object.jid %}" method="post">
                {% csrf_token %}
                <input type="Submit" class="button alert" value="Stop" />
              </form>
            </td>
            {%elif entry.object.status == 'Pending' or entry.object.status == 'In Queue'%}
            <td>
              <form action="{% url 'perfapp:Cancel' entry.object.jid %}" method="post">
                {% csrf_token %}
                <input type="Submit" class="button warning" value="Cancel" />
              </form>
            </td>
            {%elif entry.object.status == 'ERROR'%}
            <td>
              <form action="{% url 'perfapp:Cancel' entry.object.jid %}" method="post">
                {% csrf_token %}
                <input type="Submit" class="button secondary" value="Clear" />
              </form>
            </td>
            {%else%}
            <td>&nbsp&nbsp</td>
            {% endif %}
            <script>
              var Row = {};
              var job_group = "{{entry.json.id}}";
              var taskSocket = new WebSocket(
                'ws://'+ window.location.host +
                '/ws/task/' + job_group + '/'
                );
              Row["last_stat_{{entry.id}}"] = {{entry.json.status}}
              Row["last_act_{{entry.object.id}}"] = {{entry.json.cur_action}}
              taskSocket.onmessage = function(e){
                var data = JSON.parse(e.data);
                var status = data['status'];
                var action = data['action'];
                var task_id = data['task_id'];
                console.log(status);
                console.log(action);
                console.log(task_id);

                if( Row["last_act_{{entry.object.id}}"] != action){
                  $('#_action_{{entry.object.id}}').append("</br>", action);
                }
                Row["last_act_{{entry.object.id}}"] = action;
                if (status == 'ERROR'){
                  window.location.href = "/profile/";
                }
                if((Row["last_stat_{{entry.id}}"] ==null)  && status=="RUNNING"){
                  $('#_prog_wrapper').show();
                  var progressUrl = "{% url 'celery_progress:task_status'  entry.object.task_id%}";
                  document.addEventListener("DOMContentLoaded", function () {
                    CeleryProgressBar.initProgressBar(progressUrl, {progressBarId: "progress-bar {{entry.object.jid}}", progressBarMessageId: "progress-bar-message {{entry.object.jid}}"});
                  });
                }
                else if (Row["last_stat_{{entry.object.id}}"]!=status){
                $('#_status_{{entry.object.id}}').text(status);
                }
                Row["last_stat_{{entry.object.id}}"] = status;
              };
            </script>
            {%if entry.object.task_id != None%}
            <script>

            </script>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="grid-x grid-padding-x align-center">
    <div class="cell medium-8">
      <div style="display:inline;">
         <h4> Error Reports</h4>
         {% if errors != None %}
         <form action="{% url 'perfapp:Clear_All_Errs'%}" method="post">
           {% csrf_token %}
           <input type="Submit" class="hollow button alert" value="Clear All Errors" onclick="return confirm('Are you sure? This cannot be undone.')" />
         </form>
         {%endif%}
    </div>
    </div>
  </div>
  <div class="grid-x grid-padding-x align-center">
    <div class="cell medium-8">
      <table class="hover">
        <thead>
          <tr>
            <th>From Job #</th>
            <th>Timestamp</th>
            <th>&nbsp</th>
            <th>&nbsp</th>
            </tr>
          </thead>
        <tbody>
          {% for err in errors %}
          <div class="reveal" id="Modal-{{err.id}}" data-reveal>
            <h4>Errors for job# {{err.from_job_id}}</h4>
            <p>
              {{err.errors|linebreaks}}
              </p>
            <button class="close-button" data-close aria-label="close modal" type="button">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <tr>
            <td> {{err.from_job_id}}</td>
            <td> {{err.time_stamp}}</td>
            <td><button class="button" data-open="Modal-{{err.id}}">Error Report</button></td>
            <td>
              <form action="{% url 'perfapp:Delete' err.id %}" method="post">
              {% csrf_token %}
              <input type="Submit" class="button alert" value="Delete" />
              </form></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
    </div>
  </div>
</div>
{% endblock %}
{% block script%}
<script>
  var Row = {};
  var job_group = 50;
  var taskSocket = new WebSocket(
    'ws://'+ window.location.host +
    '/ws/task/' + job_group + '/'
    );
  console.log(window.location.host)
  taskSocket.onmessage = function(e){
    var data = JSON.parse(e.data);
    var status = data['status'];
    var action = data['action'];
    var task_id = data['task_id'];
    console.log(status);
    console.log(action);
    console.log(task_id);
  };
    </script>
{% endblock %}
